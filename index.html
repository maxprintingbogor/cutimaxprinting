<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Cuti dengan Export CSV/PDF (Keterangan Cuti)</title>
<style>
:root{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{max-width:1100px;margin:24px auto;padding:20px;background:#f7fafc;color:#0f172a}
.card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(12,24,40,0.06);margin-top:16px}
form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-size:13px;margin-bottom:6px}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3;font-size:14px}
textarea{height:86px;resize:vertical}
.actions{grid-column:1 / -1;display:flex;gap:8px;align-items:center}
button{padding:10px 12px;border-radius:8px;border:0;background:#0ea5ad;color:white;cursor:pointer}
button.ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
.status{padding:6px 8px;border-radius:8px;font-weight:700}
.pending{background:#fff7ed;color:#92400e}
.approved{background:#ecfdf5;color:#065f46}
.rejected{background:#fff1f2;color:#9f1239}
.small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;margin-right:4px}
.approve{background:#10b981;color:white}
.reject{background:#ef4444;color:white}
.delete{background:#f43f5e;color:white}
.edit{background:#facc15;color:white}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<section class="card" id="loginSection">
<h2>Login</h2>
<form id="loginForm">
<div><label>Username</label><input id="loginUsername" required></div>
<div><label>Password</label><input type="password" id="loginPassword" required></div>
<div class="actions">
<button type="submit">Login</button>
<button type="button" id="forgotBtn" class="ghost">Lupa Password</button>
</div>
</form>
</section>

<section class="card" id="mainSection" style="display:none">
<header>
<h1>Sistem Cuti</h1>
<button id="logoutBtn" class="ghost" style="margin-left:auto">Logout</button>
</header>

<div id="adminSection" style="display:none">
<h3>Manajemen Akun</h3>
<button id="refreshQuotaBtn" class="ghost">Perbaharui Cuti Tahun Baru</button>
<button id="exportCSVBtn" class="ghost">Export CSV</button>
<button id="exportPDFBtn" class="ghost">Export PDF</button>
<form id="addUserForm">
<div><label>Username</label><input id="newUsername" required></div>
<div><label>Password</label><input id="newPassword" required></div>
<div><label>Email</label><input id="newEmail" required></div>
<div><label>Role</label>
<select id="newRole">
<option value="user" selected>User</option>
<option value="admin">Admin</option>
</select>
</div>
<div class="actions"><button type="submit">Tambah User/Admin</button></div>
</form>
<table id="usersTable"><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>Role</th><th>Sisa Cuti</th><th>Aksi</th></tr></thead><tbody></tbody></table>

<h3>Permintaan Cuti (Admin)</h3>
<table id="adminLeaveTable"><thead><tr><th>Username</th><th>Periode</th><th>Hari</th><th>Alasan</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table>
</div>

<div id="userSection" style="display:none">
<h3>Form Pengajuan Cuti</h3>
<form id="leaveForm">
<div><label>Tanggal Mulai</label><input type="date" id="leaveStart" required></div>
<div><label>Tanggal Selesai</label><input type="date" id="leaveEnd" required></div>
<div style="grid-column:1/-1"><label>Alasan</label><textarea id="leaveReason"></textarea></div>
<div class="actions"><button type="submit">Ajukan Cuti</button></div>
</form>
<p id="leaveQuotaDisplay"></p>
<h3>Daftar Permintaan Cuti</h3>
<table id="leaveTable"><thead><tr><th>Periode</th><th>Hari</th><th>Alasan</th><th>Status</th></tr></thead><tbody></tbody></table>
</div>

<script>
let users = JSON.parse(localStorage.getItem('users') || '[]');
if(users.length===0){users=[{username:'admin',password:'admin123',email:'admin@example.com',role:'admin',quota:12}];localStorage.setItem('users',JSON.stringify(users));}
let leaveRequests = JSON.parse(localStorage.getItem('leaveRequests')||'[]');
function saveUsers(){localStorage.setItem('users',JSON.stringify(users));}
function saveLeaves(){localStorage.setItem('leaveRequests',JSON.stringify(leaveRequests));}
function daysBetween(a,b){return Math.floor((new Date(b)-new Date(a))/(1000*60*60*24))+1;}
function getLoggedUser(){return JSON.parse(localStorage.getItem('loggedUser'));}

function renderUsers(){
const tbody=document.querySelector('#usersTable tbody');tbody.innerHTML='';
users.forEach((u,i)=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${u.username}</td><td>${u.email}</td><td>${u.password}</td><td>${u.role}</td><td>${u.quota}</td><td></td>`;
const actionsTd=tr.querySelector('td:last-child');
const editBtn=document.createElement('button');editBtn.className='small-btn edit';editBtn.textContent='Edit';editBtn.onclick=()=>{
const newUsername=prompt('Username:',u.username);const newEmail=prompt('Email:',u.email);const newPassword=prompt('Password:',u.password);const newRole=prompt('Role (user/admin):',u.role);const newQuota=parseInt(prompt('Sisa Cuti:',u.quota));
if(newUsername)u.username=newUsername;if(newEmail)u.email=newEmail;if(newPassword)u.password=newPassword;if(newRole)u.role=newRole;if(!isNaN(newQuota))u.quota=newQuota;saveUsers();renderUsers();renderUserLeaves();renderAdminLeaves();};
const delBtn=document.createElement('button');delBtn.className='small-btn delete';delBtn.textContent='Hapus';delBtn.onclick=()=>{
if(confirm('Hapus user ini?')){users.splice(i,1);saveUsers();leaveRequests=leaveRequests.filter(l=>l.username!==u.username);saveLeaves();renderUsers();renderUserLeaves();renderAdminLeaves();}}
actionsTd.appendChild(editBtn);actionsTd.appendChild(document.createTextNode(' '));actionsTd.appendChild(delBtn);
tbody.appendChild(tr);
});
}

function renderAdminLeaves(){const tbody=document.querySelector('#adminLeaveTable tbody');tbody.innerHTML='';
leaveRequests.forEach((r,i)=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${r.username}</td><td>${r.start} → ${r.end}</td><td>${r.days}</td><td>${r.reason}</td><td class='status ${r.status}'>${r.status}</td><td></td>`;
if(getLoggedUser().role==='admin'){
const aBtn=document.createElement('button');aBtn.className='small-btn approve';aBtn.textContent='Setujui';aBtn.onclick=()=>{
    r.status='approved';saveLeaves();renderAdminLeaves();renderUserLeaves();
};
const rBtn=document.createElement('button');rBtn.className='small-btn reject';rBtn.textContent='Tolak';rBtn.onclick=()=>{
    r.status='rejected';saveLeaves();renderAdminLeaves();renderUserLeaves();
};
const dBtn=document.createElement('button');dBtn.className='small-btn delete';dBtn.textContent='Hapus';dBtn.onclick=()=>{if(confirm('Hapus permintaan cuti ini?')){leaveRequests.splice(i,1);saveLeaves();renderAdminLeaves();renderUserLeaves();}};
tr.querySelector('td:last-child').appendChild(aBtn);tr.querySelector('td:last-child').appendChild(document.createTextNode(' '));tr.querySelector('td:last-child').appendChild(rBtn);tr.querySelector('td:last-child').appendChild(document.createTextNode(' '));tr.querySelector('td:last-child').appendChild(dBtn);
}
tbody.appendChild(tr);});
}

function renderUserLeaves(){const tbody=document.querySelector('#leaveTable tbody');tbody.innerHTML='';const u=getLoggedUser();leaveRequests.filter(r=>r.username===u.username).forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.start} → ${r.end}</td><td>${r.days}</td><td>${r.reason}</td><td class='status ${r.status}'>${r.status}</td>`;tbody.appendChild(tr);});updateQuotaDisplay();}

function updateQuotaDisplay(){const u=getLoggedUser();if(u){let used = leaveRequests.filter(l=>l.username===u.username && l.status==='approved').reduce((a,b)=>a+b.days,0);document.getElementById('leaveQuotaDisplay').textContent=`Sisa Cuti: ${u.quota-used}`;}}

// Login
document.getElementById('loginForm').addEventListener('submit',e=>{
e.preventDefault();
const uname=document.getElementById('loginUsername').value.trim();
const pwd=document.getElementById('loginPassword').value.trim();
const user=users.find(x=>x.username===uname && x.password===pwd);
if(user){localStorage.setItem('loggedUser',JSON.stringify(user));showSections();}else alert('Login gagal');
});
document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('loggedUser');location.reload();});
document.getElementById('forgotBtn').addEventListener('click',()=>{const uname=prompt('Masukkan username');const u=users.find(x=>x.username===uname);if(u)alert(`Password: ${u.password}`);else alert('User tidak ditemukan');});

// Reset cuti tahunan
document.getElementById('refreshQuotaBtn').addEventListener('click', () => {
    if(confirm('Apakah Anda yakin ingin memperbaharui cuti semua user untuk tahun baru?')) {
        users.forEach(u => { u.quota = 12; });
        saveUsers();
        alert('Sisa cuti semua user telah diperbaharui untuk tahun baru.');
        renderUsers();
        renderUserLeaves();
    }
});

// Export CSV
document.getElementById('exportCSVBtn').addEventListener('click', () => {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Username,Email,Password,Role,Sisa Cuti,Periode Cuti,Hari,Alasan,Status\n";
    users.forEach(u => {
        let userLeaves = leaveRequests.filter(r => r.username === u.username);
        if(userLeaves.length === 0){
            csvContent += `${u.username},${u.email},${u.password},${u.role},${u.quota},-,-,-,-\n`;
        } else {
            userLeaves.forEach(r => {
                csvContent += `${u.username},${u.email},${u.password},${u.role},${u.quota},${r.start} → ${r.end},${r.days},${r.reason},${r.status}\n`;
            });
        }
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "data_cuti.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

// Export PDF
document.getElementById('exportPDFBtn').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text("Data User dan Cuti", 10, 10);

    let startY = 20;
    doc.text("Username | Email | Password | Role | Sisa Cuti | Periode Cuti | Hari | Alasan | Status", 10, startY);
    startY += 10;

    users.forEach(u => {
        const userCuti = leaveRequests.filter(r => r.username === u.username);
        if(userCuti.length === 0){
            doc.text(`${u.username} | ${u.email} | ${u.password} | ${u.role} | ${u.quota} | - | - | - | -`, 10, startY);
            startY += 10;
        } else {
            userCuti.forEach(r => {
                doc.text(`${u.username} | ${u.email} | ${u.password} | ${u.role} | ${u.quota} | ${r.start} → ${r.end} | ${r.days} | ${r.reason} | ${r.status}`, 10, startY);
                startY += 10;
            });
        }
    });

    doc.save("data_cuti.pdf");
});

function showSections(){const u=getLoggedUser();if(!u)return;document.getElementById('loginSection').style.display='none';document.getElementById('mainSection').style.display='block';
if(u.role==='admin'){document.getElementById('adminSection').style.display='block';document.getElementById('userSection').style.display='none';renderUsers();renderAdminLeaves();}else{document.getElementById('adminSection').style.display='none';document.getElementById('userSection').style.display='block';renderUserLeaves();}}

// User submit leave
document.getElementById('leaveForm').addEventListener('submit',e=>{
e.preventDefault();const u=getLoggedUser();
const s=document.getElementById('leaveStart').value;
const eDate=document.getElementById('leaveEnd').value;
if(new Date(eDate)<new Date(s)){alert('Tanggal selesai tidak boleh sebelum mulai'); return;}
const reason=document.getElementById('leaveReason').value;
const days=daysBetween(s,eDate);
leaveRequests.push({username:u.username,start:s,end:eDate,days,reason,status:'pending'});saveLeaves();renderUserLeaves();});

// Admin add user
document.getElementById('addUserForm').addEventListener('submit',e=>{
e.preventDefault();
const username=document.getElementById('newUsername').value.trim();
const password=document.getElementById('newPassword').value.trim();
const email=document.getElementById('newEmail').value.trim();
const role=document.getElementById('newRole').value;
users.push({username,password,email,role,quota:12});saveUsers();renderUsers();
});

</script>
</body>
</html>