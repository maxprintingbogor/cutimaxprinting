<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Cuti Maxprinting (Online)</title>
<style>
:root{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{max-width:1100px;margin:24px auto;padding:20px;background:#f1f5f9;color:#0f172a}
.card{background:white;border-radius:10px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-top:16px}
form{display:grid;grid-template-columns:1fr 1fr;gap:15px}
label{display:block;font-size:13px;margin-bottom:6px;font-weight:600;color:#475569}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:14px;background:#fff; color:#1e293b; box-sizing: border-box;}
textarea{height:80px;resize:vertical}
.actions{grid-column:1 / -1;display:flex;gap:8px;align-items:center; margin-top:10px;}

/* Button Styles */
button{padding:10px 16px;border-radius:8px;border:0;font-weight:600;cursor:pointer;transition:all 0.2s;}
button.primary{background:#0ea5ad;color:white;}
button.primary:hover{background:#0b8d94}
button.ghost{background:transparent;border:1px solid #cbd5e1;color:#475569}
button.ghost:hover{background:#f1f5f9; border-color:#94a3b8}

/* Table Styles */
.table-wrap{overflow-x:auto;margin-top:15px;border:1px solid #e2e8f0;border-radius:8px; background:white;}
table{width:100%;border-collapse:collapse;}
thead th{background:#f8fafc;padding:12px;text-align:left;font-size:13px;color:#475569;border-bottom:1px solid #e2e8f0;font-weight:700; text-transform: uppercase; letter-spacing: 0.5px;}
tbody tr{border-bottom:1px solid #f1f5f9;}
tbody tr:last-child{border-bottom:0;}
th,td{padding:14px 12px;text-align:left;font-size:14px;vertical-align:middle}

/* Status Badges */
.status{padding:4px 10px;border-radius:99px;font-weight:700;display:inline-block;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
.pending{background:#fff7ed;color:#b45309;border:1px solid #ffedd5}
.approved{background:#f0fdf4;color:#15803d;border:1px solid #dcfce7}
.rejected{background:#fef2f2;color:#b91c1c;border:1px solid #fee2e2}

/* Action Buttons */
.small-btn{padding:6px 10px;border-radius:6px;border:0;cursor:pointer;margin-right:4px;font-size:12px;font-weight:600}
.approve{background:#dcfce7;color:#166534} .approve:hover{background:#bbf7d0}
.reject{background:#fee2e2;color:#991b1b} .reject:hover{background:#fecaca}
.delete{background:#f3f4f6;color:#4b5563} .delete:hover{background:#e5e7eb}
.edit{background:#fef9c3;color:#854d0e} .edit:hover{background:#fde047}

/* Layout */
.user-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
@media (max-width:900px){ 
    form{grid-template-columns:1fr} 
    .actions{flex-direction:column;align-items:stretch} 
    .user-grid { grid-template-columns: 1fr; }
}
.export{background:#3b82f6;color:white}

/* Calendar */
.calendar-wrap{background:white;border-radius:10px;padding:16px;margin-top:16px;border:1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
.cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.cal-day{padding:8px;text-align:center;font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase}
.cal-cell{padding:5px;border-radius:6px;text-align:center;background:#fff;border:1px solid #f1f5f9;min-height:40px;display:flex;align-items:center;justify-content:center;position: relative;font-size:14px; font-weight: 500; color:#334155}
.cal-disabled{opacity:0.4;background:#f8fafc;border-color:transparent; color:#cbd5e1}
.cal-marked{background:#fff1f2;border:1px solid #fda4af;color:#be123c;font-weight:bold}
.cal-today{box-shadow:0 0 0 2px #0ea5ad; border-color:transparent; font-weight:bold; color:#0ea5ad}
.cal-nav{padding:6px 12px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;cursor:pointer; font-weight: bold;}
.cal-legend{display:flex;gap:8px;align-items:center;font-size:13px;margin-top:15px;color:#64748b; background: #f8fafc; padding: 8px; border-radius: 6px;}
.legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#fda4af;border:1px solid #be123c}

/* Branch List */
.branch-list { list-style:none; padding:0; margin:0; display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
.branch-item { background:#fff; padding:6px 12px; border-radius:6px; display:flex; align-items:center; gap:8px; font-size:13px; border:1px solid #cbd5e1; }
.branch-del { color:#ef4444; cursor:pointer; font-weight:bold; padding:2px 6px; border-radius:4px; }
.branch-del:hover { background:#fee2e2; }

/* Modal & Toast */
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal-box { background:white; padding:24px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); }
.modal-title { margin-top:0; font-size:18px; color:#1e293b; }
.modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }
.toast { position:fixed; bottom:20px; right:20px; background:#1e293b; color:white; padding:12px 20px; border-radius:8px; font-size:14px; z-index:2000; transform:translateY(100px); transition:transform 0.3s; }
.toast.show { transform:translateY(0); }

/* Loading */
.loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; align-items:center; justify-content:center; z-index:2000; flex-direction: column; gap:15px;}
.spinner { width:40px; height:40px; border:4px solid #e2e8f0; border-top-color:#0ea5ad; border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>

<!-- Firebase SDK (Modular) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div style="color:#64748b; font-size:14px; font-weight:600">Menghubungkan ke Database...</div>
</div>

<!-- LOGIN SECTION -->
<section class="card" id="loginSection" style="max-width:400px; margin:80px auto; padding:40px; display:none">
  <h2 style="margin-top:0; text-align:center; color:#0ea5ad; margin-bottom:20px">Login Sistem Cuti</h2>
  <form id="loginForm" style="grid-template-columns:1fr; gap:20px">
    <div><label>Username</label><input id="loginUsername" required placeholder="Contoh: admin"></div>
    <div><label>Password</label><input type="password" id="loginPassword" required placeholder="Contoh: admin123"></div>
    <button type="submit" class="primary" style="width:100%; margin-top:10px; height:45px; font-size:16px">Masuk</button>
  </form>
  <div style="margin-top:25px; font-size:13px; color:#64748b; text-align:center; background:#f1f5f9; padding:15px; border-radius:8px; line-height:1.6">
    <strong>Akun Default:</strong><br>
    Username: <b>admin</b><br>Password: <b>admin123</b>
  </div>
</section>

<!-- MAIN APPLICATION WRAPPER -->
<div id="mainWrapper" style="display:none">
  
  <header style="display:flex;align-items:center;gap:12px;border-bottom:1px solid #e2e8f0;padding-bottom:16px;margin-bottom:20px">
    <h1 style="margin:0;font-size:24px; color:#0ea5ad; font-weight:800">Sistem Cuti</h1>
    <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
      <div style="text-align:right">
        <span id="whoami" style="font-size:15px;color:#334155;font-weight:700"></span><br>
        <span id="myBranch" style="font-size:12px;color:#64748b;"></span>
      </div>
      <button id="logoutBtn" class="ghost" style="padding:8px 16px">Keluar</button>
    </div>
  </header>

  <!-- === ADMIN SECTION === -->
  <div id="adminSection" style="display:none">
    
    <!-- BRANCH MANAGEMENT (PUSAT ONLY) -->
    <div id="branchMgmtArea" style="background:#f0f9ff; padding:16px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:20px;">
        <h3 style="margin-top:0; font-size:16px; color:#0369a1">Manajemen Cabang (Pusat)</h3>
        <form id="addBranchForm" style="grid-template-columns: 1fr auto; align-items:end;">
            <div><label>Nama Cabang Baru</label><input id="newBranchName" required placeholder="Contoh: Cabang Bandung"></div>
            <button type="submit" class="small-btn approve" style="height:42px; padding:0 20px; font-size:14px">+ Tambah</button>
        </form>
        <ul id="branchList" class="branch-list"></ul>
    </div>

    <!-- MANAJEMEN AKUN -->
    <h3 style="margin-top:0; color:#334155">Manajemen Akun User</h3>
    <form id="addUserForm" style="margin-bottom:12px; background:white; padding:20px; border-radius:10px; border:1px solid #e2e8f0">
      <div><label>Username</label><input id="newUsername" required></div>
      <div><label>Password</label><input id="newPassword" required></div>
      <div><label>Email (opsional)</label><input id="newEmail"></div>
      <div>
        <label>Role</label>
        <select id="newRole"><option value="user">User</option><option value="admin">Admin</option></select>
      </div>
      <div>
        <label>Cabang</label>
        <select id="newBranchSelect"></select>
      </div>
      
      <div class="actions">
          <button type="submit" class="primary">Tambah Akun</button>
          <button type="button" id="resetQuotaBtn" class="ghost">Reset Semua Kuota (12)</button>
      </div>
    </form>

    <div class="table-wrap">
      <table id="usersTable">
        <thead><tr><th>Username</th><th>Cabang</th><th>Email</th><th>Role</th><th>Sisa Cuti</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <hr style="margin:40px 0; border:0; border-top:1px solid #e2e8f0">

    <h3 style="margin-top:0; color:#334155">Permintaan Cuti</h3>

    <!-- CALENDAR ADMIN -->
    <div id="adminCalendar" class="calendar-wrap">
      <div class="cal-header">
        <button class="cal-nav" id="adminPrev">‚Üê</button>
        <strong id="adminCalTitle"></strong>
        <button class="cal-nav" id="adminNext">‚Üí</button>
      </div>
      <div id="adminCalGrid" class="cal-grid"></div>
      <div class="cal-legend"><span class="legend-dot legend-applied"></span> Pengajuan Cuti (Sesuai Hak Akses)</div>
    </div>

    <!-- FILTERS -->
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:20px 0; align-items:end; background:#f8fafc; padding:20px; border-radius:10px; border:1px solid #e2e8f0">
      <div style="flex:1; min-width:120px">
        <label>Status</label>
        <select id="filterStatus"><option value="all">Semua</option><option value="pending">Pending</option><option value="approved">Disetujui</option><option value="rejected">Ditolak</option></select>
      </div>
      <div style="flex:1; min-width:120px">
        <label>User</label>
        <select id="filterUser"><option value="all">Semua</option></select>
      </div>
      <div style="flex:1; min-width:120px">
        <label>Cabang</label>
        <select id="filterBranch"><option value="all">Semua</option></select>
      </div>
      <div style="flex:1; min-width:120px">
        <label>Tanggal</label>
        <input type="date" id="filterDate">
      </div>
      <div style="flex:1; min-width:120px">
        <label>Bulan</label>
        <select id="filterMonth"><option value="all">Semua</option><option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">Mei</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Agu</option><option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option></select>
      </div>
      <div style="flex:1; min-width:120px">
        <label>Tahun</label>
        <select id="filterYear"><option value="all">Semua</option></select>
      </div>
      <div>
        <button id="exportCSVBtn" class="primary" style="background:#3b82f6">CSV</button>
        <button id="exportPDFBtn" class="primary" style="background:#ef4444">PDF</button>
      </div>
    </div>

    <!-- DELETE RANGE -->
    <div style="display:flex;gap:10px;align-items:end;margin-bottom:12px; background:#fff1f2; padding:20px; border-radius:10px; border:1px solid #fecdd3">
      <div style="flex:1"><label>Hapus Dari</label><input type="date" id="deleteRangeStart"></div>
      <div style="flex:1"><label>Sampai</label><input type="date" id="deleteRangeEnd"></div>
      <div style="flex:1">
        <label>Cabang (Hapus)</label>
        <select id="deleteRangeBranch"><option value="all">Semua Cabang</option></select>
      </div>
      <button id="btnDeleteRange" style="background:#e11d48; color:white; border:0">Hapus Range</button>
    </div>

    <div class="table-wrap">
      <table id="adminLeaveTable">
        <thead><tr><th>Username</th><th>Cabang</th><th>Periode</th><th>Hari</th><th>Alasan</th><th>Status</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- === USER SECTION === -->
  <div id="userSection" style="display:none;">
    <h3 style="margin-top:0; color:#334155">Form Pengajuan Cuti</h3>
    
    <div class="user-grid">
        <div class="card" style="margin-top:0">
            <form id="leaveForm" style="margin-bottom:20px">
              <div><label>Tanggal Mulai</label><input type="date" id="leaveStart" required></div>
              <div><label>Tanggal Selesai</label><input type="date" id="leaveEnd" required></div>
              <div style="grid-column:1/-1"><label>Alasan</label><textarea id="leaveReason" placeholder="Keperluan cuti..." required></textarea></div>
              <div class="actions"><button type="submit" class="primary" style="width:100%">Ajukan Cuti</button></div>
            </form>
            <div id="leaveQuotaDisplay" style="background:#f0f9ff; padding:15px; border-radius:8px; text-align:center; color:#0369a1; font-weight:bold; font-size:18px; border:1px solid #bae6fd"></div>
        </div>
        
        <div class="card" style="margin-top:0; padding:0; overflow:hidden; border:0; box-shadow:none">
            <div id="userCalendar" class="calendar-wrap" style="margin-top:0; border:1px solid #e2e8f0">
              <div class="cal-header">
                <button class="cal-nav" id="userPrev">‚Üê</button>
                <strong id="userCalTitle"></strong>
                <button class="cal-nav" id="userNext">‚Üí</button>
              </div>
              <div id="userCalGrid" class="cal-grid"></div>
              <div class="cal-legend"><span class="legend-dot legend-applied"></span> Jadwal Cuti Rekan (Satu Cabang)</div>
            </div>
        </div>
    </div>

    <hr style="margin:40px 0; border:0; border-top:1px solid #e2e8f0">

    <h3>Riwayat Pengajuan</h3>
    <div class="table-wrap">
      <table id="leaveTable">
        <thead><tr><th>Periode</th><th>Hari</th><th>Alasan</th><th>Status</th><th>Keterangan Admin</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div class="card">
        <h3 style="margin-top:0">Ganti Password</h3>
        <form id="changePassForm" style="max-width:500px">
        <div><label>Password Lama</label><input type="password" id="oldPass" required></div>
        <div><label>Password Baru</label><input type="password" id="newPass1" required></div>
        <div><label>Ulangi Password Baru</label><input type="password" id="newPass2" required></div>
        <div class="actions"><button type="submit" class="ghost">Simpan Password</button></div>
        </form>
    </div>
  </div>
</div>

<!-- Custom Modal & Toast -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modalTitle" class="modal-title">Konfirmasi</h3>
        <p id="modalMessage" style="color:#64748b; margin-bottom:20px"></p>
        
        <!-- Input field for prompts -->
        <div id="modalInputContainer" style="display:none; margin-bottom:20px;">
            <input type="text" id="modalInput" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px">
        </div>

        <div class="modal-actions">
            <button id="modalCancel" class="ghost">Batal</button>
            <button id="modalConfirm" class="primary">Ya</button>
        </div>
    </div>
</div>
<div id="toast" class="toast">Pesan notifikasi</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, updatePassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// 1. GLOBAL VARIABLES
let usersData = [];
let branchesData = [];
let leaveRequestsData = [];
let currentUser = null;

// Calendar State
const calState = {
  admin: { month: new Date().getMonth(), year: new Date().getFullYear() },
  user:  { month: new Date().getMonth(), year: new Date().getFullYear() }
};

// 2. FIREBASE INIT
// --- AREA KONFIGURASI FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCjhzOFYKABH0sbj3rEgstsbnWhWUpAKEk",
  authDomain: "sistemcutimax.firebaseapp.com",
  projectId: "sistemcutimax",
  storageBucket: "sistemcutimax.firebasestorage.app",
  messagingSenderId: "900339400070",
  appId: "1:900339400070:web:d030cf5c960e97cd408007"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

// Helper Paths
const colUsers = () => collection(db, 'artifacts', appId, 'public', 'data', 'users');
const colBranches = () => collection(db, 'artifacts', appId, 'public', 'data', 'branches');
const colLeaves = () => collection(db, 'artifacts', appId, 'public', 'data', 'leave_requests');

// 3. HELPER FUNCTIONS
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function openModal(title, message, isPrompt = false, defaultValue = '') {
    return new Promise((resolve) => {
        const overlay = document.getElementById('modalOverlay');
        const titleEl = document.getElementById('modalTitle');
        const msgEl = document.getElementById('modalMessage');
        const inputCont = document.getElementById('modalInputContainer');
        const input = document.getElementById('modalInput');
        const btnConfirm = document.getElementById('modalConfirm');
        const btnCancel = document.getElementById('modalCancel');

        titleEl.textContent = title;
        msgEl.textContent = message;
        
        if(isPrompt) {
            inputCont.style.display = 'block';
            input.value = defaultValue;
            input.focus();
        } else {
            inputCont.style.display = 'none';
        }

        overlay.style.display = 'flex';

        const close = (val) => {
            overlay.style.display = 'none';
            btnConfirm.onclick = null;
            btnCancel.onclick = null;
            resolve(val);
        };

        btnConfirm.onclick = () => close(isPrompt ? input.value : true);
        btnCancel.onclick = () => close(isPrompt ? null : false);
    });
}

function parseDateLocal(s) {
    if(!s) return null;
    const p = s.split('-').map(Number);
    return new Date(p[0], p[1]-1, p[2]);
}

function daysBetween(a,b){ 
    const dA = parseDateLocal(a);
    const dB = parseDateLocal(b);
    if (dA > dB) return 0; // Negative or zero days if end is before start
    return Math.floor((dB - dA)/(1000*60*60*24)) + 1; 
}

function addMonths(month, year, delta){
  month += delta;
  while(month<0){ month += 12; year -= 1; }
  while(month>11){ month -= 12; year += 1; }
  return { month, year };
}

function isSuperAdmin(u) { return u && u.role === 'admin' && u.branch === 'Pusat'; }

// 4. CORE LOGIC: INIT & AUTH
async function initApp() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (e) {
        console.error("Auth Failed:", e);
        try { await signInAnonymously(auth); } catch (e2) { showToast("Gagal koneksi database"); return; }
    }

    // Database Listeners
    const errHandler = (err) => {
        console.error("Snapshot Error:", err);
        if (err.code === 'permission-denied') showToast("Izin akses ditolak. Refresh halaman.");
    };

    onSnapshot(colUsers(), (snap) => {
        usersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if(usersData.length === 0) seedDefaultAdmin();
        refreshUI();
    }, errHandler);

    onSnapshot(colBranches(), (snap) => {
        branchesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if(branchesData.length === 0) seedDefaultBranches();
        refreshUI();
    }, errHandler);

    onSnapshot(colLeaves(), (snap) => {
        leaveRequestsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        refreshUI(); // Will trigger calendar render automatically
    }, errHandler);

    document.getElementById('loadingOverlay').style.display = 'none';
    checkSession();
}

async function seedDefaultAdmin() {
    try {
        await setDoc(doc(colUsers(), 'admin'), {
            username: 'admin', password: 'admin123', role: 'admin', branch: 'Pusat', email: 'admin@pusat.com', quota: 12
        });
    } catch(e){}
}

async function seedDefaultBranches() {
    ['Pusat', 'Cabang A', 'Cabang B'].forEach(async (b) => {
        try { await setDoc(doc(colBranches(), b), { name: b }); } catch(e){}
    });
}

function checkSession() {
    const stored = localStorage.getItem('app_session_user');
    if (stored) {
        if(usersData.length > 0) {
            const u = usersData.find(u => u.username === stored);
            if(u) { currentUser = u; showSections(); return; }
        }
    }
    if(!currentUser) document.getElementById('loginSection').style.display = 'block';
}

function refreshUI() {
    // 1. Update currentUser object reference
    if (currentUser) {
        const freshUser = usersData.find(u => u.username === currentUser.username);
        if(freshUser) currentUser = freshUser;
    }
    
    // 2. Restore session if data arrived late
    if (!currentUser) {
        const stored = localStorage.getItem('app_session_user');
        if (stored) {
            const u = usersData.find(u => u.username === stored);
            if (u) { currentUser = u; showSections(); }
        }
    }
    
    // 3. Render UI if logged in
    if (currentUser) {
        document.getElementById('whoami').textContent = `Halo, ${currentUser.username}`;
        document.getElementById('myBranch').textContent = isSuperAdmin(currentUser) ? '(Super Admin - Pusat)' : `(${currentUser.role} - ${currentUser.branch})`;

        if (currentUser.role === 'admin') {
            renderBranches();
            renderUsersTable();
            renderAdminLeaves();
        } else {
            renderUserLeaves();
        }
        populateFilterOptions();
        renderAllCalendars(); // AUTOMATIC RENDER
    }
}

function showSections() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainWrapper').style.display = 'block';
    
    const adminSec = document.getElementById('adminSection');
    const userSec = document.getElementById('userSection');
    const branchMgmt = document.getElementById('branchMgmtArea');
    
    const isSuper = isSuperAdmin(currentUser);

    if (currentUser.role === 'admin') {
        adminSec.style.display = 'block';
        userSec.style.display = 'none';
        branchMgmt.style.display = isSuper ? 'block' : 'none';
    } else {
        adminSec.style.display = 'none';
        userSec.style.display = 'block';
    }
    
    // FORCE RENDER CALENDAR WITH DELAY
    setTimeout(() => renderAllCalendars(), 200); 
}

/* ---------- CALENDAR RENDERING ---------- */
function renderAllCalendars() {
    if (!currentUser) return;

    ['admin','user'].forEach(mode => {
        const grid = document.getElementById(`${mode}CalGrid`);
        const title = document.getElementById(`${mode}CalTitle`);
        if(!grid || !title) return;
        
        const state = calState[mode];
        grid.innerHTML = '';
        const now = new Date();
        const year = state.year; const month = state.month;
        const monthNames = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
        title.textContent = `${monthNames[month]} ${year}`;

        // Header
        ['Min','Sen','Sel','Rab','Kam','Jum','Sab'].forEach(d => {
            const el = document.createElement('div'); el.className='cal-day'; el.textContent=d; grid.appendChild(el);
        });

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday
        const firstDayGridIndex = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1; // 0 for Monday (M=0, T=1... S=6)
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Blanks (offset for day 1 to Monday start)
        for(let i=0; i<firstDayGridIndex; i++) {
            const el = document.createElement('div'); el.className='cal-cell cal-disabled'; grid.appendChild(el);
        }
        
        // Marks Logic
        const marks = new Set();
        const isSuper = isSuperAdmin(currentUser);
        
        leaveRequestsData.forEach(r => {
            // Only show approved/pending leaves
            if(r.status === 'rejected') return;
            
            const u = usersData.find(x => x.username === r.username);
            const userBranch = u ? u.branch : (currentUser.branch || 'Pusat');
            
            // ADMIN: sees all based on their branch access (or all if super admin)
            // USER: sees leaves from users in the same branch
            if (currentUser.role === 'admin' && !isSuper && userBranch !== currentUser.branch) return;
            if (currentUser.role === 'user' && userBranch !== currentUser.branch) return; 

            // Prevent user from seeing their OWN pending/approved leave mark on the user calendar (but let admin see it)
            if (mode === 'user' && r.username === currentUser.username) return;

            let s = parseDateLocal(r.start); let e = parseDateLocal(r.end);
            if(!s || !e) return;

            let c = new Date(s);
            while(c <= e) {
                if(c.getMonth() === month && c.getFullYear() === year) marks.add(c.getDate());
                c.setDate(c.getDate()+1);
            }
        });

        for(let d=1; d<=daysInMonth; d++) {
            const el = document.createElement('div');
            el.className = 'cal-cell';
            el.textContent = d;
            if(marks.has(d)) el.classList.add('cal-marked');
            if(year === now.getFullYear() && month === now.getMonth() && d === now.getDate()) el.classList.add('cal-today');
            grid.appendChild(el);
        }
    });
}

// Navigation Handlers
['admin','user'].forEach(m => {
    const prev = document.getElementById(`${m}Prev`);
    const next = document.getElementById(`${m}Next`);
    if(prev) prev.onclick = () => { 
        calState[m] = addMonths(calState[m].month, calState[m].year, -1); renderAllCalendars(); 
    };
    if(next) next.onclick = () => { 
        calState[m] = addMonths(calState[m].month, calState[m].year, 1); renderAllCalendars(); 
    };
});

/* ---------- BRANCH MANAGEMENT ---------- */
function renderBranches() {
    const list = document.getElementById('branchList');
    const select = document.getElementById('newBranchSelect');
    if(!list || !select) return;
    const isSuper = isSuperAdmin(currentUser);
    list.innerHTML = ''; 
    
    // Clear and rebuild branch select for user/admin creation
    const currentOptions = Array.from(select.options).map(o => o.value);
    select.innerHTML = '';

    branchesData.sort((a,b) => a.name.localeCompare(b.name)).forEach(b => {
        // Render list for Super Admin
        if (isSuper) {
            const li = document.createElement('li'); li.className='branch-item'; li.innerHTML=`<span>${b.name}</span>`;
            if (b.name !== 'Pusat') {
                const sp = document.createElement('span'); sp.className='branch-del'; sp.innerHTML='&times;';
                sp.onclick = async()=>{ 
                    if(await openModal('Hapus?','Hapus '+b.name+'? Ini tidak bisa dibatalkan!')) {
                        // Check if users exist in this branch before deleting
                        if (usersData.some(u => u.branch === b.name)) {
                            await openModal('Peringatan', 'Tidak bisa menghapus cabang. Pindahkan semua user dari cabang ini terlebih dahulu.');
                        } else {
                            await deleteDoc(doc(colBranches(), b.id)); 
                            showToast('Cabang '+b.name+' berhasil dihapus');
                        }
                    } 
                };
                li.appendChild(sp);
            }
            list.appendChild(li);
        }

        // Populate select box (Admin sees all, User only sees their branch but Admin is here)
        const o = document.createElement('option'); o.value=b.name; o.textContent=b.name; select.appendChild(o);
    });
}
document.getElementById('addBranchForm').addEventListener('submit', async(e)=>{
    e.preventDefault(); 
    const n=document.getElementById('newBranchName').value.trim();
    if(n && !branchesData.find(b=>b.name===n)) { 
        await setDoc(doc(colBranches(), n), {name:n}); 
        document.getElementById('newBranchName').value='';
        showToast('Cabang '+n+' berhasil ditambahkan');
    } else if (n) {
        showToast('Nama cabang sudah ada');
    }
});

/* ---------- USER MANAGEMENT ---------- */
function renderUsersTable(){
    const tb = document.querySelector('#usersTable tbody'); if(!tb)return; tb.innerHTML='';
    const isSuper = isSuperAdmin(currentUser);
    
    usersData.sort((a,b) => a.username.localeCompare(b.username)).forEach(u=>{
        // Filter users based on admin's branch
        if(!isSuper && u.branch !== currentUser.branch) return;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.username}</td><td>${u.branch}</td><td>${u.email||'-'}</td><td>${u.role}</td><td>${u.quota}</td><td></td>`;
        const td = tr.querySelector('td:last-child');

        // Edit Button (Quota & Branch)
        const be = document.createElement('button'); be.className='small-btn edit'; be.textContent='Edit';
        be.onclick = async()=>{
            if(u.username === 'admin' && u.role === 'admin' && u.branch === 'Pusat') return showToast('Akun default ini tidak bisa diedit.');
            
            const newBranch = isSuper ? (await openModal('Edit Cabang','Nama cabang baru:',true,u.branch)) : u.branch;
            if(newBranch) { 
                const newQuotaStr = await openModal('Edit Kuota','Sisa kuota cuti (Angka):',true,u.quota.toString()); 
                const newQuota = parseInt(newQuotaStr);
                
                if(!isNaN(newQuota) && newQuota >= 0) {
                    await updateDoc(doc(colUsers(), u.id),{branch:newBranch, quota:newQuota});
                    showToast('Data user berhasil diupdate');
                } else if (newQuotaStr !== null) {
                    showToast('Quota harus berupa angka positif.');
                }
            }
        };

        // Delete Button
        const bd = document.createElement('button'); bd.className='small-btn delete'; bd.textContent='Hapus';
        bd.onclick = async()=>{ 
            if(u.username === 'admin' && u.role === 'admin' && u.branch === 'Pusat') return showToast('Akun default ini tidak bisa dihapus.');
            if(await openModal('Hapus User?', 'Hapus user '+u.username+' secara permanen?')) {
                await deleteDoc(doc(colUsers(), u.id)); 
                showToast('User berhasil dihapus');
            } 
        };
        
        td.appendChild(be);
        // Only allow deleting others
        if(u.username!==currentUser.username) td.appendChild(bd);
        
        tb.appendChild(tr);
    });
}
document.getElementById('addUserForm').addEventListener('submit', async(e)=>{
    e.preventDefault(); 
    const u=document.getElementById('newUsername').value.trim();
    if(usersData.find(x=>x.username===u)) return showToast('Username sudah ada');
    
    // Check if branch exists
    if(!branchesData.some(b => b.name === document.getElementById('newBranchSelect').value)) {
        return showToast('Cabang tidak valid. Harap refresh.');
    }

    await setDoc(doc(colUsers(), u), {
        username:u, password:document.getElementById('newPassword').value, 
        email:document.getElementById('newEmail').value, role:document.getElementById('newRole').value,
        branch:document.getElementById('newBranchSelect').value, quota:12
    });
    e.target.reset();
    showToast('Akun baru berhasil ditambahkan');
});

document.getElementById('resetQuotaBtn').addEventListener('click', async()=>{
    if(await openModal('Reset Quota?', 'Reset semua sisa cuti user (kecuali admin pusat) menjadi 12 hari?')){
        const isSuper = isSuperAdmin(currentUser);
        const updates = usersData.map(u=>{ 
            if(u.username !== 'admin' && (isSuper || u.branch === currentUser.branch)) {
                return updateDoc(doc(colUsers(),u.id),{quota:12}); 
            }
            return Promise.resolve();
        });
        await Promise.all(updates);
        showToast('Semua kuota cuti sudah di-reset menjadi 12');
    }
});

/* ---------- LEAVE MANAGEMENT (ADMIN) ---------- */
function getFilteredLeaves() {
    const status = document.getElementById('filterStatus').value;
    const user = document.getElementById('filterUser').value;
    const branch = document.getElementById('filterBranch').value;
    const date = document.getElementById('filterDate').value;
    const month = document.getElementById('filterMonth').value;
    const year = document.getElementById('filterYear').value;
    const isSuper = isSuperAdmin(currentUser);

    return leaveRequestsData.filter(r => {
        const start = parseDateLocal(r.start);
        if(!start) return false;
        const u = usersData.find(x => x.username === r.username);
        const uBranch = u ? u.branch : '-';
        
        // Access Control: Admin only sees their branch or all if Super Admin
        if(!isSuper && uBranch !== currentUser.branch) return false;
        
        // Filters
        if(status !== 'all' && r.status !== status) return false;
        if(user !== 'all' && r.username !== user) return false;
        if(branch !== 'all' && uBranch !== branch) return false;
        
        if(date) {
            const d = parseDateLocal(date); const end = parseDateLocal(r.end);
            if(!(d >= start && d <= end)) return false;
        }
        if(month !== 'all' && (start.getMonth()+1).toString() !== month) return false;
        if(year !== 'all') {
            const startYear = start.getFullYear().toString();
            // Check if the range (start or end) touches the filtered year
            const end = parseDateLocal(r.end);
            const endYear = end.getFullYear().toString();
            if(startYear !== year && endYear !== year) return false;
        }
        return true;
    }).sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0)); // Sort by newest submission
}

function renderAdminLeaves() {
    const tbody = document.querySelector('#adminLeaveTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const list = getFilteredLeaves();
    if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px">Tidak ada data</td></tr>'; return; }
    list.forEach(r => {
        const u = usersData.find(x => x.username === r.username);
        const br = u ? u.branch : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.username}</td><td>${br}</td><td>${r.start} -> ${r.end}</td><td>${r.days}</td><td>${r.reason}</td><td><span class="status ${r.status}">${r.status}</span></td><td></td>`;
        const acts = tr.querySelector('td:last-child');
        const mkBtn = (cls, txt, fn) => {
            const b = document.createElement('button'); b.className=`small-btn ${cls}`; b.textContent=txt; b.onclick=fn; acts.appendChild(b);
        };
        
        // Approve Button
        mkBtn('approve','‚úì', async () => {
            if(await openModal('Setujui?', `Setujui pengajuan ${r.days} hari dari ${r.username}?`)) {
                const note = await openModal('Catatan', 'Pesan persetujuan:', true, 'Disetujui');
                if (note === null) return; 

                // Quota logic: Only adjust quota if status changes to APPROVED
                if(r.status !== 'approved') {
                    // Check quota again before final approval
                    const targetUser = usersData.find(x => x.username === r.username);
                    if (targetUser && targetUser.quota < r.days) {
                         return openModal('Gagal', `Quota ${targetUser.username} tidak cukup (${targetUser.quota} hari tersisa).`);
                    }
                    await changeQuota(r.username, -r.days);
                }
                
                await updateDoc(doc(colLeaves(), r.id), { status: 'approved', note: note });
                showToast('Pengajuan Disetujui');
            }
        });
        
        // Reject Button
        mkBtn('reject','‚úó', async () => {
            if(await openModal('Tolak?', `Tolak pengajuan ${r.days} hari dari ${r.username}?`)) {
                const note = await openModal('Alasan', 'Alasan penolakan:', true, 'Ditolak') || 'Ditolak';
                
                // Quota logic: Only restore quota if status changes from APPROVED to REJECTED
                if(r.status === 'approved') {
                    await changeQuota(r.username, r.days);
                }
                
                await updateDoc(doc(colLeaves(), r.id), { status: 'rejected', note: note });
                showToast('Pengajuan Ditolak');
            }
        });
        
        // Delete Button
        mkBtn('delete','üóë', async () => {
            if(await openModal('Hapus?', 'Hapus data ini permanen? Ini tidak bisa dibatalkan.', false)) {
                // Restore quota if it was approved
                if(r.status === 'approved') await changeQuota(r.username, r.days);
                await deleteDoc(doc(colLeaves(), r.id));
                showToast('Data Cuti Dihapus');
            }
        });
        acts.style.whiteSpace = 'nowrap';
        tbody.appendChild(tr);
    });
}

async function changeQuota(uname, delta) {
    const u = usersData.find(x => x.username === uname);
    if(u) {
        // Ensure new quota is not negative
        const n = Math.max(0, (u.quota || 0) + delta);
        await updateDoc(doc(colUsers(), u.id), { quota: n });
    }
}

function populateFilterOptions(){
    const us = document.getElementById('filterUser'); 
    const bs = document.getElementById('filterBranch');
    const ds = document.getElementById('deleteRangeBranch');
    const ys = document.getElementById('filterYear');
    const isSuper = isSuperAdmin(currentUser);
    
    // User Filter
    us.innerHTML='<option value="all">Semua</option>';
    usersData.sort((a,b) => a.username.localeCompare(b.username)).forEach(u=>{ 
        if(isSuper||u.branch===currentUser.branch){ 
            const o=document.createElement('option');o.value=u.username;o.textContent=u.username;us.appendChild(o);
        }
    });
    
    // Branch Filter (Admin)
    const bo = '<option value="all">Semua</option>'; 
    bs.innerHTML=bo; ds.innerHTML=bo;
    const adminBranches = branchesData.filter(b => isSuper || b.name === currentUser.branch).sort((a,b) => a.name.localeCompare(b.name));
    
    if(isSuper){
        bs.disabled=false; ds.disabled=false;
        adminBranches.forEach(b=>{
            const o=document.createElement('option');o.value=b.name;o.textContent=b.name;
            bs.appendChild(o.cloneNode(true)); ds.appendChild(o.cloneNode(true));
        });
    } else {
        // Non-super admin is limited to their branch
        bs.innerHTML=`<option value="${currentUser.branch}">${currentUser.branch}</option>`; bs.disabled=true;
        ds.innerHTML=`<option value="${currentUser.branch}">${currentUser.branch}</option>`; ds.disabled=true;
    }

    // Year Filter
    ys.innerHTML='<option value="all">Semua</option>';
    const currentYear = new Date().getFullYear();
    for(let y=currentYear-1; y<=currentYear+1; y++){
        const o=document.createElement('option');o.value=y;o.textContent=y;ys.appendChild(o);
    }

    // Attach event listeners
    ['filterStatus','filterUser','filterBranch','filterDate','filterMonth','filterYear'].forEach(i=>document.getElementById(i).onchange=renderAdminLeaves);
}

document.getElementById('btnDeleteRange').addEventListener('click', async()=>{
    const s=document.getElementById('deleteRangeStart').value; 
    const e=document.getElementById('deleteRangeEnd').value;
    const br=document.getElementById('deleteRangeBranch').value;
    
    if(!s || !e) return showToast('Harap isi tanggal mulai dan selesai');

    if(await openModal('Hapus Permanen?', 'Hapus semua data cuti dalam rentang tanggal ini secara permanen?')) {
        const st=parseDateLocal(s); 
        const en=parseDateLocal(e); 
        const p=[];
        
        leaveRequestsData.forEach(r=>{
            const rs=parseDateLocal(r.start); 
            const re=parseDateLocal(r.end);
            
            // Check if the ranges overlap
            if(!(st<=re && rs<=en)) return;
            
            const u=usersData.find(x=>x.username===r.username);
            
            // Check branch filter
            if(!u || (br!=='all' && u.branch!==br)) return;
            
            // Restore quota if it was approved
            if(r.status==='approved') p.push(changeQuota(r.username, r.days));
            p.push(deleteDoc(doc(colLeaves(), r.id)));
        });
        
        if (p.length > 0) {
            await Promise.all(p); 
            showToast('Data cuti berhasil dihapus dalam rentang yang ditentukan.');
        } else {
            showToast('Tidak ada data cuti yang cocok dengan filter rentang tersebut.');
        }
    }
});

/* ---------- LEAVE MANAGEMENT (USER) ---------- */
function renderUserLeaves() {
    const quotaDisplay = document.getElementById('leaveQuotaDisplay');
    if (quotaDisplay && currentUser) {
        quotaDisplay.textContent = `Sisa Kuota Cuti Anda: ${currentUser.quota} Hari`;
    }
    
    const tbody = document.querySelector('#leaveTable tbody');
    if(!tbody) return; 
    tbody.innerHTML = '';
    
    const userLeaves = leaveRequestsData
        .filter(r => r.username === currentUser.username)
        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); // Sort by newest first
        
    if(userLeaves.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px">Belum ada pengajuan cuti.</td></tr>'; 
        return;
    }

    userLeaves.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${r.start} -> ${r.end}</td>
            <td>${r.days}</td>
            <td>${r.reason}</td>
            <td><span class="status ${r.status}">${r.status}</span></td>
            <td>${r.note || '-'}</td>
        `;
        tbody.appendChild(tr);
    });
}


document.getElementById('leaveForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const start = document.getElementById('leaveStart').value;
    const end = document.getElementById('leaveEnd').value;
    const reason = document.getElementById('leaveReason').value.trim();

    if (!start || !end || !reason) return showToast('Semua field wajib diisi');
    
    const startDate = parseDateLocal(start);
    const endDate = parseDateLocal(end);
    
    if (startDate >= endDate) return showToast('Tanggal akhir harus setelah tanggal mulai.');
    
    const days = daysBetween(start, end);

    if (days > currentUser.quota) return openModal('Peringatan', `Sisa cuti Anda hanya ${currentUser.quota} hari. Anda mengajukan ${days} hari.`);

    if (await openModal('Konfirmasi', `Ajukan cuti selama ${days} hari (Tgl ${start} s/d ${end})?`)) {
        await addDoc(colLeaves(), {
            username: currentUser.username,
            start: start,
            end: end,
            days: days,
            reason: reason,
            status: 'pending',
            createdAt: new Date().getTime(),
            note: ''
        });
        document.getElementById('leaveForm').reset();
        showToast('Pengajuan cuti berhasil dikirim! Menunggu persetujuan Admin.');
    }
});

/* ---------- PASSWORD CHANGE (USER) ---------- */
document.getElementById('changePassForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const oldPass = document.getElementById('oldPass').value;
    const newPass1 = document.getElementById('newPass1').value;
    const newPass2 = document.getElementById('newPass2').value;

    if (newPass1 !== newPass2) return showToast('Password baru tidak cocok.');
    if (oldPass !== currentUser.password) return showToast('Password lama salah.');
    if (newPass1.length < 6) return showToast('Password baru minimal 6 karakter.');
    
    if (await openModal('Ubah Password?', 'Anda yakin ingin mengubah password?')) {
        // Update Firestore
        await updateDoc(doc(colUsers(), currentUser.id), { password: newPass1 });
        
        // Clear form
        e.target.reset();
        showToast('Password berhasil diubah!');
    }
});

/* ---------- EXPORT FUNCTIONS (ADMIN) ---------- */
function getExportData() {
    const list = getFilteredLeaves();
    const headers = ['Username', 'Cabang', 'Tgl Mulai', 'Tgl Selesai', 'Hari', 'Alasan', 'Status', 'Catatan Admin'];
    const body = list.map(r => {
        const u = usersData.find(x => x.username === r.username);
        const br = u ? u.branch : '-';
        return [r.username, br, r.start, r.end, r.days, r.reason, r.status, r.note || '-'];
    });
    return { headers, body };
}

document.getElementById('exportCSVBtn').addEventListener('click', () => {
    const { headers, body } = getExportData();
    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
        headers.join(',') + '\n' +
        body.map(e => e.map(f => `"${f.toString().replace(/"/g, '""')}"`).join(',')).join('\n');
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "data_cuti.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('Data diexport ke CSV');
});

document.getElementById('exportPDFBtn').addEventListener('click', () => {
    const { headers, body } = getExportData();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    doc.autoTable({
        head: [headers],
        body: body,
        startY: 20,
        styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
        headStyles: { fillColor: [14, 165, 173], textColor: 255, fontStyle: 'bold' },
        didDrawPage: function (data) {
            doc.setFontSize(14);
            doc.setTextColor(15, 23, 42);
            doc.text("Laporan Data Cuti Karyawan", data.settings.margin.left, 15);
        }
    });

    doc.save('data_cuti.pdf');
    showToast('Data diexport ke PDF');
});


/* ---------- LOGIN & LOGOUT ---------- */
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const uVal = document.getElementById('loginUsername').value.trim();
    const pVal = document.getElementById('loginPassword').value.trim();
    
    // Check if data is loaded
    if(usersData.length === 0) return showToast('Data user belum dimuat. Tunggu sebentar atau refresh.');

    const found = usersData.find(u => u.username === uVal && u.password === pVal);
    if(found) {
        currentUser = found;
        localStorage.setItem('app_session_user', uVal);
        showSections();
        refreshUI();
        showToast(`Selamat datang, ${uVal}!`);
    } else {
        await openModal('Gagal', 'Username atau Password salah.');
    }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('app_session_user');
    currentUser = null;
    showToast('Berhasil Keluar');
    location.reload();
});

// START
initApp();
</script>
</body>
</html>
