<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Cuti Maxprinting</title>
<style>
:root{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{max-width:1100px;margin:24px auto;padding:20px;background:#f7fafc;color:#0f172a}
.card{background:white;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(12,24,40,0.06);margin-top:16px}
form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{display:block;font-size:13px;margin-bottom:6px}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3;font-size:14px;background:#fff}
textarea{height:80px;resize:vertical}
.actions{grid-column:1 / -1;display:flex;gap:8px;align-items:center}
button{padding:9px 12px;border-radius:8px;border:0;background:#0ea5ad;color:white;cursor:pointer}
button.ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a}
.table-wrap{overflow:auto;margin-top:12px}
table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{background:transparent;padding:8px;text-align:left;font-size:13px;color:#334155}
tbody tr{background:white;border-radius:8px;box-shadow:0 2px 6px rgba(12,24,40,0.03)}
th,td{padding:12px 10px;border-bottom:0;text-align:left;font-size:14px;vertical-align:middle}
td:first-child, th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
td:last-child, th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
.status{padding:6px 10px;border-radius:999px;font-weight:700;display:inline-block;font-size:13px}
.pending{background:#fff7ed;color:#92400e}
.approved{background:#ecfdf5;color:#065f46}
.rejected{background:#fff1f2;color:#9f1239}
.small-btn{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;margin-right:6px;font-size:13px}
.approve{background:#10b981;color:white}
.reject{background:#ef4444;color:white}
.delete{background:#f43f5e;color:white}
.edit{background:#facc15;color:#08204a}
@media (max-width:900px){ form{grid-template-columns:1fr} .actions{flex-direction:column;align-items:stretch} table{font-size:13px} }
.export{background:#3b82f6;color:white}
.note-small{font-size:13px;color:#64748b}
</style>

<!-- jsPDF + AutoTable (AutoTable must be loaded after jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<section class="card" id="loginSection">
  <h2>Login</h2>
  <form id="loginForm">
    <div><label>Username</label><input id="loginUsername" required></div>
    <div><label>Password</label><input type="password" id="loginPassword" required></div>
    <div class="actions">
      <button type="submit">Login</button>
    </div>
  </form>
</section>

<!-- MAIN -->
<section class="card" id="mainSection" style="display:none">
  <header style="display:flex;align-items:center;gap:12px">
    <h1 style="margin:0">Sistem Cuti</h1>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <span id="whoami" style="font-size:14px;color:#334155"></span>
      <button id="logoutBtn" class="ghost">Logout</button>
    </div>
  </header>

  <!-- ADMIN -->
  <div id="adminSection" style="display:none;margin-top:12px">
    <h3>Manajemen Akun</h3>
    <form id="addUserForm" style="margin-bottom:12px">
      <div><label>Username</label><input id="newUsername" required></div>
      <div><label>Password</label><input id="newPassword" required></div>
      <div><label>Email (opsional)</label><input id="newEmail"></div>
      <div>
        <label>Role</label>
        <select id="newRole"><option value="user">User</option><option value="admin">Admin</option></select>
      </div>
      <div class="actions"><button type="submit">Tambah User/Admin</button><button type="button" id="resetQuotaBtn" class="ghost">Reset Cuti Semua</button></div>
    </form>

    <div class="table-wrap">
      <table id="usersTable">
        <thead><tr><th>Username</th><th>Email</th><th>Password</th><th>Role</th><th>Sisa Cuti</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <hr style="margin:12px 0">

    <h3>Permintaan Cuti (Admin)</h3>

    <!-- FILTERS -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <div>
        <label>Status</label>
        <select id="filterStatus"><option value="all">Semua</option><option value="pending">Pending</option><option value="approved">Disetujui</option><option value="rejected">Ditolak</option></select>
      </div>
      <div>
        <label>User</label>
        <select id="filterUser"><option value="all">Semua</option></select>
      </div>
      <div>
        <label>Tanggal (tepat)</label>
        <input type="date" id="filterDate">
      </div>
      <div>
        <label>Bulan</label>
        <select id="filterMonth"><option value="all">Semua</option>
          <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
          <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
          <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
      </div>
      <div>
        <label>Tahun</label>
        <select id="filterYear"><option value="all">Semua</option></select>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:end">
        <button id="exportCSVBtn" class="ghost">Export CSV</button>
        <button id="exportPDFBtn" class="ghost">Export PDF</button>
      </div>
    </div>

    <!-- DELETE BY DATE RANGE -->
    <div style="display:flex;gap:8px;align-items:end;margin-bottom:12px">
      <div>
        <label>Hapus Cuti - Dari tanggal</label>
        <input type="date" id="deleteRangeStart">
      </div>
      <div>
        <label>Sampai tanggal</label>
        <input type="date" id="deleteRangeEnd">
      </div>
      <div style="align-self:flex-end">
        <button id="btnDeleteRange" class="ghost">Hapus Cuti dalam Rentang</button>
      </div>
      <div style="align-self:flex-end;color:#64748b;font-size:13px">(Hanya menghapus pengajuan, <strong>tidak menghapus user</strong>)</div>
    </div>

    <div class="table-wrap">
      <table id="adminLeaveTable">
        <thead><tr><th>Username</th><th>Periode</th><th>Hari</th><th>Alasan</th><th>Status</th><th>Keterangan Admin</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- USER -->
  <div id="userSection" style="display:none;margin-top:12px">
    <h3>Pengajuan Cuti</h3>
    <form id="leaveForm" style="margin-bottom:12px">
      <div><label>Tanggal Mulai</label><input type="date" id="leaveStart" required></div>
      <div><label>Tanggal Selesai</label><input type="date" id="leaveEnd" required></div>
      <div style="grid-column:1/-1"><label>Alasan</label><textarea id="leaveReason"></textarea></div>
      <div class="actions"><button type="submit">Ajukan Cuti</button></div>
    </form>

    <p id="leaveQuotaDisplay"></p>

    <h3>Ganti Password</h3>
    <form id="changePassForm" style="margin-bottom:12px">
      <div><label>Password Lama</label><input type="password" id="oldPass" required></div>
      <div><label>Password Baru</label><input type="password" id="newPass1" required></div>
      <div><label>Ulangi Password Baru</label><input type="password" id="newPass2" required></div>
      <div class="actions"><button type="submit">Perbarui Password</button></div>
    </form>

    <h3>Riwayat Pengajuan</h3>
    <div class="table-wrap">
      <table id="leaveTable">
        <thead><tr><th>Periode</th><th>Hari</th><th>Alasan</th><th>Status</th><th>Keterangan Admin</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</section>

<script>
/* ---------- Data init ---------- */
let users = JSON.parse(localStorage.getItem('users') || '[]');
function saveUsers(){ localStorage.setItem('users', JSON.stringify(users)); }
if(users.length === 0){
  users = [{ username: 'admin', password: 'admin123', email: 'admin@example.com', role: 'admin', quota: 12 }];
  saveUsers();
}
let leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
function saveLeaves(){ localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests)); }

function daysBetween(a,b){ return Math.floor((new Date(b) - new Date(a))/(1000*60*60*24)) + 1; }
function getLoggedUser(){ return JSON.parse(localStorage.getItem('loggedUser')); }

/* ---------- Helpers: keep loggedUser in sync ---------- */
function syncLoggedUserIfMatches(username, newUserObj){
  const logged = getLoggedUser();
  if(!logged) return;
  if(logged.username === username){
    // update stored loggedUser to reflect latest user object
    localStorage.setItem('loggedUser', JSON.stringify(newUserObj));
  }
}

/* ---------- Render users (admin table) ---------- */
function renderUsers(){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  users.forEach((u, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.username}</td><td>${u.email || '-'}</td><td>*****</td><td>${u.role}</td><td>${u.quota}</td><td></td>`;
    const actionsTd = tr.querySelector('td:last-child');

    // edit user
    const editBtn = document.createElement('button'); editBtn.className='small-btn edit'; editBtn.textContent='Edit';
    editBtn.onclick = () => {
      const newUser = prompt('Username:', u.username);
      const newEmail = prompt('Email (opsional):', u.email || '');
      const newPwd = prompt('Password (kosong = tetap):', '');
      const newRole = prompt('Role (user/admin):', u.role);
      const newQuota = prompt('Sisa Cuti (angka):', u.quota);
      if(newUser) u.username = newUser;
      u.email = (newEmail !== null) ? newEmail : u.email;
      if(newPwd) u.password = newPwd;
      if(newRole) u.role = newRole;
      if(!isNaN(parseInt(newQuota))) u.quota = parseInt(newQuota);
      saveUsers(); renderUsers(); populateFilterOptions(); renderAdminLeavesFiltered();
      alert('Perubahan disimpan');
      // sync loggedUser if admin is editing themselves
      syncLoggedUserIfMatches(u.username, u);
      updateWhoami();
    };

    // delete user: ONLY remove account, keep leaveRequests intact
    const delBtn = document.createElement('button'); delBtn.className='small-btn delete'; delBtn.textContent='Hapus';
    delBtn.onclick = () => {
      if(!confirm(`Hapus user "${u.username}"? (pengajuan cuti TIDAK akan dihapus)`)) return;
      // if deleting currently loggedUser, remove loggedUser so they get logged out automatically
      const logged = getLoggedUser();
      const removedUsername = u.username;
      users.splice(idx,1);
      saveUsers();
      if(logged && logged.username === removedUsername){
        localStorage.removeItem('loggedUser');
        alert('Anda (user yang dihapus) akan dikeluarkan dari sesi.');
        location.reload();
        return;
      }
      renderUsers(); renderAdminLeavesFiltered(); renderUserLeaves(); populateFilterOptions();
    };

    actionsTd.appendChild(editBtn); actionsTd.appendChild(document.createTextNode(' ')); actionsTd.appendChild(delBtn);
    tbody.appendChild(tr);
  });
}

/* ---------- Admin leaves (with filters, newest first) ---------- */
function renderAdminLeavesFiltered(){
  const statusFilter = document.getElementById('filterStatus').value || 'all';
  const userFilter = document.getElementById('filterUser').value || 'all';
  const dateFilter = document.getElementById('filterDate').value || '';
  const monthFilter = document.getElementById('filterMonth').value || 'all';
  const yearFilter = document.getElementById('filterYear').value || 'all';

  const tbody = document.querySelector('#adminLeaveTable tbody');
  tbody.innerHTML = '';

  // sort newest first by id timestamp if available, otherwise by start date desc
  const leavesSorted = [...leaveRequests].sort((a,b)=>{
    if(a.id && b.id) return (b.id > a.id) ? 1 : -1;
    return new Date(b.start) - new Date(a.start);
  });

  leavesSorted.forEach((r) => {
    const start = new Date(r.start);
    const end = new Date(r.end);
    if(statusFilter !== 'all' && r.status !== statusFilter) return;
    if(userFilter !== 'all' && r.username !== userFilter) return;
    if(dateFilter){ const d = new Date(dateFilter); if(!(d >= start && d <= end)) return; }
    if(monthFilter !== 'all'){ if((start.getMonth()+1).toString() !== monthFilter) return; }
    if(yearFilter !== 'all'){ if(start.getFullYear().toString() !== yearFilter) return; }

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.username}</td><td>${r.start} → ${r.end}</td><td>${r.days}</td><td>${(r.reason||'-')}</td><td><span class="status ${r.status}">${r.status}</span></td><td>${(r.note||'-')}</td><td></td>`;
    const actionsTd = tr.querySelector('td:last-child');

    // approve
    const aBtn = document.createElement('button'); aBtn.className='small-btn approve'; aBtn.textContent='Setujui';
    aBtn.onclick = () => {
      if(!confirm('Setujui pengajuan ini?')) return;
      const note = prompt('Keterangan persetujuan (opsional):','Disetujui') || 'Disetujui';
      r.status = 'approved'; r.note = note;
      const usr = users.find(u => u.username === r.username);
      if(usr){
        usr.quota = Math.max(0, (parseInt(usr.quota)||0) - r.days);
        saveUsers();
        // if approved user is currently logged in, sync
        syncLoggedUserIfMatches(usr.username, usr);
      }
      saveLeaves(); renderAdminLeavesFiltered(); renderUserLeaves(); renderUsers(); populateFilterOptions();
    };

    // reject
    const rBtn = document.createElement('button'); rBtn.className='small-btn reject'; rBtn.textContent='Tolak';
    rBtn.onclick = () => {
      if(!confirm('Tolak pengajuan ini?')) return;
      const note = prompt('Alasan penolakan (opsional):','Ditolak') || 'Ditolak';
      r.status = 'rejected'; r.note = note;
      saveLeaves(); renderAdminLeavesFiltered(); renderUserLeaves();
    };

    // delete
    const dBtn = document.createElement('button'); dBtn.className='small-btn delete'; dBtn.textContent='Hapus';
    dBtn.onclick = () => {
      if(!confirm('Hapus pengajuan ini?')) return;
      const realIndex = leaveRequests.findIndex(x => x.id === r.id && x.username === r.username && x.start === r.start && x.end === r.end);
      if(realIndex > -1){ leaveRequests.splice(realIndex,1); saveLeaves(); }
      renderAdminLeavesFiltered(); renderUserLeaves(); populateFilterOptions();
    };

    actionsTd.appendChild(aBtn); actionsTd.appendChild(document.createTextNode(' '));
    actionsTd.appendChild(rBtn); actionsTd.appendChild(document.createTextNode(' '));
    actionsTd.appendChild(dBtn);

    tbody.appendChild(tr);
  });
}

/* ---------- User side: render history & quota ---------- */
function renderUserLeaves(){
  const tbody = document.querySelector('#leaveTable tbody'); tbody.innerHTML = '';
  const u = getLoggedUser(); if(!u) return;
  // newest first for user as well
  const myLeaves = leaveRequests.filter(r => r.username === u.username).sort((a,b)=> {
    if(a.id && b.id) return (b.id > a.id) ? 1 : -1;
    return new Date(b.start) - new Date(a.start);
  });
  myLeaves.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.start} → ${r.end}</td><td>${r.days}</td><td>${(r.reason||'-')}</td><td><span class="status ${r.status}">${r.status}</span></td><td>${(r.note||'-')}</td>`;
    tbody.appendChild(tr);
  });
  updateQuotaDisplay();
}

function updateQuotaDisplay(){
  const u = getLoggedUser(); if(!u) return;
  const used = leaveRequests.filter(l => l.username === u.username && l.status === 'approved').reduce((a,b)=>a + (b.days||0),0);
  const remaining = (u.quota || 0) - used;
  // reflect remaining in users array display as well (keeps admin view consistent)
  const usr = users.find(x => x.username === u.username);
  if(usr) usr.quota = Math.max(0, remaining);
  saveUsers();
  document.getElementById('leaveQuotaDisplay').textContent = `Sisa Cuti: ${remaining}`;
  // re-render users table for up-to-date quota
  renderUsers();
}

/* ---------- Login / Logout ---------- */
document.getElementById('loginForm').addEventListener('submit', e => {
  e.preventDefault();
  const uname = document.getElementById('loginUsername').value.trim();
  const pwd = document.getElementById('loginPassword').value.trim();
  const user = users.find(x => x.username === uname && x.password === pwd);
  if(!user){ alert('Login gagal — periksa username & password'); return; }
  localStorage.setItem('loggedUser', JSON.stringify(user));
  showSections();
});

document.getElementById('logoutBtn').addEventListener('click', ()=> {
  localStorage.removeItem('loggedUser'); location.reload();
});

/* ---------- Admin: add user ---------- */
document.getElementById('addUserForm').addEventListener('submit', e => {
  e.preventDefault();
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const role = document.getElementById('newRole').value;
  if(!username || !password){ alert('Username & password wajib diisi'); return; }
  if(users.find(u => u.username === username)){ alert('Username sudah ada'); return; }
  users.push({ username, password, email: email||'', role, quota: 12 });
  saveUsers(); renderUsers(); populateFilterOptions();
  alert('User ditambahkan');
  e.target.reset();
});

/* ---------- Leave submit with overlap warning ---------- */
document.getElementById('leaveForm').addEventListener('submit', e => {
  e.preventDefault();
  const u = getLoggedUser(); if(!u){ alert('Login terlebih dahulu'); return; }
  const s = document.getElementById('leaveStart').value;
  const eDate = document.getElementById('leaveEnd').value;
  if(!s || !eDate){ alert('Pilih tanggal'); return; }
  if(new Date(eDate) < new Date(s)){ alert('Tanggal selesai tidak boleh sebelum tanggal mulai'); return; }
  const days = daysBetween(s,eDate);
  const reason = document.getElementById('leaveReason').value || '-';

  // find overlaps with other users (any status)
  function overlaps(aStart,aEnd,bStart,bEnd){
    return (aStart <= bEnd) && (bStart <= aEnd);
  }
  const start = new Date(s);
  const end = new Date(eDate);
  const overlapsList = leaveRequests.filter(r => {
    if(r.username === u.username) return false; // ignore own existing requests
    const rs = new Date(r.start), re = new Date(r.end);
    return overlaps(start,end,rs,re);
  }).map(r => `${r.username} (${r.start}→${r.end})`);

  if(overlapsList.length){
    const proceed = confirm(`Terdapat ${overlapsList.length} pengajuan lain yang overlap:\n- ${overlapsList.join('\n- ')}\n\nLanjutkan mengajukan cuti?`);
    if(!proceed) return;
  }

  const record = { id: 'r_'+Date.now(), username: u.username, start: s, end: eDate, days, reason, status: 'pending', note: '-' };
  leaveRequests.push(record);
  saveLeaves(); renderUserLeaves(); renderAdminLeavesFiltered(); populateFilterOptions();
  alert('Pengajuan terkirim');
  e.target.reset();
});

/* ---------- User: change password ---------- */
document.getElementById('changePassForm').addEventListener('submit', e => {
  e.preventDefault();
  const u = getLoggedUser(); if(!u) return alert('Login terlebih dahulu');
  const old = document.getElementById('oldPass').value;
  const n1 = document.getElementById('newPass1').value;
  const n2 = document.getElementById('newPass2').value;
  if(old !== u.password) return alert('Password lama salah');
  if(n1 !== n2) return alert('Password baru tidak sama');
  if(n1.length < 4) return alert('Minimal 4 karakter');
  const usr = users.find(x => x.username === u.username);
  usr.password = n1; saveUsers(); localStorage.setItem('loggedUser', JSON.stringify(usr));
  alert('Password berhasil diperbarui'); e.target.reset();
});

/* ---------- Reset quota (admin) ---------- */
document.getElementById('resetQuotaBtn').addEventListener('click', ()=> {
  if(!confirm('Set sisa cuti semua user ke 12 hari?')) return;
  users.forEach(u => u.quota = 12); saveUsers(); renderUsers(); renderUserLeaves(); alert('Sisa cuti diperbaharui');
});

/* ---------- Export CSV (safe quoting) ---------- */
document.getElementById('exportCSVBtn').addEventListener('click', ()=> {
  const leavesSorted = [...leaveRequests].sort((a,b)=> (b.id && a.id) ? ((b.id>a.id)?1:-1) : (new Date(b.start)-new Date(a.start)));
  let csv = `"Username","Periode","Hari","Alasan","Status","Keterangan Admin"\n`;
  leavesSorted.forEach(r => {
    const safe = txt => `"${(txt||'').toString().replace(/"/g,'""')}"`;
    csv += `${safe(r.username)},${safe(r.start + ' → ' + r.end)},${safe(r.days)},${safe(r.reason||'-')},${safe(r.status)},${safe(r.note||'-')}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'permintaan_cuti.csv'; a.click();
});

/* ---------- Export PDF (AutoTable) with footer & status colors ---------- */
document.getElementById('exportPDFBtn').addEventListener('click', ()=> {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","pt","a4");

  const leavesSorted = [...leaveRequests].sort((a,b)=> (b.id && a.id) ? ((b.id>a.id)?1:-1) : (new Date(b.start)-new Date(a.start)));
  const rows = leavesSorted.map(r => [r.username, `${r.start} → ${r.end}`, r.days, r.reason || "-", r.status, r.note || "-"]);

  doc.setFontSize(15);
  doc.text("Data Permintaan Cuti", 40, 40);

  doc.autoTable({
    startY: 60,
    head: [['Username','Periode','Hari','Alasan','Status','Keterangan Admin']],
    body: rows,
    styles:{fontSize:10,cellPadding:6},
    headStyles:{fillColor:[52,152,219],textColor:255},
    alternateRowStyles:{fillColor:[250,250,250]},
    margin:{left:40,right:40},
    didParseCell: function(data){
      // color status column (index 4)
      if (data.section === 'body' && data.column.index === 4) {
        const status = (data.cell.raw || '').toString().toLowerCase();
        if(status === 'approved' || status === 'disetujui') {
          data.cell.styles.textColor = [0,120,0];
          data.cell.styles.fontStyle = 'bold';
        } else if(status === 'rejected' || status === 'ditolak') {
          data.cell.styles.textColor = [180,0,0];
          data.cell.styles.fontStyle = 'bold';
        } else {
          // pending
          data.cell.styles.textColor = [190,150,0];
          data.cell.styles.fontStyle = 'bold';
        }
      }
    },
    didDrawPage: function(data){
      const pageHeight = doc.internal.pageSize.height;
      const printedAt = new Date().toLocaleString("id-ID", {
        day: "2-digit", month: "long", year: "numeric", hour: "2-digit", minute: "2-digit"
      });
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`Dicetak pada: ${printedAt}`, data.settings.margin.left, pageHeight - 20);
      const pageCount = doc.internal.getNumberOfPages();
      doc.text(`Halaman ${pageCount}`, doc.internal.pageSize.width - 120, pageHeight - 20);
    }
  });

  doc.save('permintaan_cuti.pdf');
});

/* ---------- Populate filters: user & year and listeners ---------- */
function populateFilterOptions(){
  const userSelect = document.getElementById('filterUser');
  userSelect.innerHTML = '<option value="all">Semua</option>';
  users.forEach(u => { const opt = document.createElement('option'); opt.value = u.username; opt.textContent = u.username; userSelect.appendChild(opt); });

  const yearSelect = document.getElementById('filterYear');
  yearSelect.innerHTML = '<option value="all">Semua</option>';
  const years = new Set();
  leaveRequests.forEach(r => { const y = new Date(r.start).getFullYear(); if(!isNaN(y)) years.add(y); });
  Array.from(years).sort().forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; yearSelect.appendChild(opt); });

  ['filterStatus','filterUser','filterDate','filterMonth','filterYear'].forEach(id => {
    const el = document.getElementById(id); if(el) el.addEventListener('change', renderAdminLeavesFiltered);
  });
}

/* ---------- DELETE BY DATE RANGE: logic & UI handler ---------- */
function rangesOverlap(aStart, aEnd, bStart, bEnd){
  return (aStart <= bEnd) && (bStart <= aEnd);
}

document.getElementById('btnDeleteRange').addEventListener('click', ()=> {
  const s = document.getElementById('deleteRangeStart').value;
  const e = document.getElementById('deleteRangeEnd').value;
  if(!s || !e){ alert('Isi kedua tanggal (awal & akhir) untuk penghapusan.'); return; }
  const start = new Date(s);
  const end = new Date(e);
  if(end < start){ alert('Tanggal akhir harus sama atau setelah tanggal awal.'); return; }

  const toDelete = leaveRequests.filter(r => {
    const rs = new Date(r.start);
    const re = new Date(r.end);
    return rangesOverlap(start, end, rs, re);
  });

  if(toDelete.length === 0){
    alert('Tidak ada pengajuan cuti dalam rentang tanggal tersebut.');
    return;
  }

  if(!confirm(`Akan menghapus ${toDelete.length} pengajuan cuti yang overlap rentang ${s} → ${e}.\nLanjutkan?`)) return;

  leaveRequests = leaveRequests.filter(r => {
    const rs = new Date(r.start);
    const re = new Date(r.end);
    return !rangesOverlap(start, end, rs, re);
  });

  saveLeaves();
  populateFilterOptions(); renderAdminLeavesFiltered(); renderUserLeaves();
  alert(`${toDelete.length} pengajuan cuti berhasil dihapus.`);
});

/* ---------- Whoami & Show sections ---------- */
function updateWhoami(){
  const u = getLoggedUser();
  document.getElementById('whoami').textContent = u ? `${u.username} (${u.role})` : '';
}

function showSections(){
  const u = getLoggedUser();
  if(!u) return;
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('mainSection').style.display = 'block';
  updateWhoami();
  if(u.role === 'admin'){
    document.getElementById('adminSection').style.display = 'block';
    document.getElementById('userSection').style.display = 'none';
    renderUsers(); populateFilterOptions(); renderAdminLeavesFiltered();
  } else {
    document.getElementById('adminSection').style.display = 'none';
    document.getElementById('userSection').style.display = 'block';
    renderUserLeaves(); renderUsers(); populateFilterOptions();
  }
}

/* ---------- Init / Keep logged in ---------- */
if(localStorage.getItem('loggedUser')) showSections();
else { renderUsers(); populateFilterOptions(); renderAdminLeavesFiltered(); renderUserLeaves(); }
window.addEventListener('load', ()=>{ renderUsers(); populateFilterOptions(); renderAdminLeavesFiltered(); renderUserLeaves(); updateWhoami(); });
</script>
</body>
</html>
